<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0" />
  <title>Athleten Check-In</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet" />
  <style>
    

    :root {
      --bg:        #0a0a0f;
      --surface:   #13131c;
      --surface2:  #1c1c2a;
      --border:    #2a2a3e;
      --accent:    #e8ff47;
      --accent2:   #47d4ff;
      --danger:    #ff4747;
      --text:      #f0f0f8;
      --muted:     #6b6b8a;
      --radius:    14px;
      --font-head: 'Bebas Neue', sans-serif;
      --font-body: 'DM Sans', sans-serif;
    }

    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    html, body {
      min-height: 100%;
      background: var(--bg);
      color: var(--text);
      font-family: var(--font-body);
      -webkit-font-smoothing: antialiased;
    }

    body {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      padding: 24px 16px 48px;
      background:
        radial-gradient(ellipse 80% 40% at 50% -10%, rgba(232,255,71,.07) 0%, transparent 70%),
        radial-gradient(ellipse 60% 50% at 110% 80%, rgba(71,212,255,.05) 0%, transparent 60%),
        var(--bg);
    }

    /* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */
    header {
      width: 100%;
      max-width: 480px;
      text-align: center;
      padding: 32px 0 24px;
      animation: fadeDown .5s ease both;
    }

    .logo-icon {
      width: 52px;
      height: 52px;
      background: var(--accent);
      border-radius: 14px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 16px;
    }
    .logo-icon svg { width: 28px; height: 28px; }

    h1 {
      font-family: var(--font-head);
      font-size: clamp(2.4rem, 8vw, 3.2rem);
      letter-spacing: .06em;
      line-height: 1;
      color: var(--text);
    }
    h1 span { color: var(--accent); }

    .header-sub {
      margin-top: 8px;
      font-size: .85rem;
      color: var(--muted);
      letter-spacing: .05em;
    }

    /* ‚îÄ‚îÄ CARD ‚îÄ‚îÄ */
    .card {
      width: 100%;
      max-width: 480px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 20px;
      padding: 28px 24px;
      margin-bottom: 16px;
      animation: fadeUp .45s ease both;
    }
    .card + .card { animation-delay: .06s; }

    .card-label {
      font-size: .68rem;
      font-weight: 600;
      letter-spacing: .12em;
      text-transform: uppercase;
      color: var(--muted);
      margin-bottom: 14px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .card-label::after {
      content: '';
      flex: 1;
      height: 1px;
      background: var(--border);
    }

    /* ‚îÄ‚îÄ KURS DISPLAY ‚îÄ‚îÄ */
    .kurs-display {
      background: linear-gradient(135deg, var(--surface2) 0%, rgba(232,255,71,.05) 100%);
      border: 1px solid rgba(232,255,71,.2);
      border-radius: var(--radius);
      padding: 18px 20px;
      display: flex;
      align-items: center;
      gap: 16px;
    }
    .kurs-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: var(--accent);
      flex-shrink: 0;
      box-shadow: 0 0 12px var(--accent);
      animation: pulse 2s ease-in-out infinite;
    }
    .kurs-dot.inactive {
      background: var(--muted);
      box-shadow: none;
      animation: none;
    }
    .kurs-name {
      font-family: var(--font-head);
      font-size: 1.4rem;
      letter-spacing: .04em;
      line-height: 1.1;
    }
    .kurs-time {
      font-size: .8rem;
      color: var(--muted);
      margin-top: 2px;
    }
    .kurs-badge {
      margin-left: auto;
      font-size: .65rem;
      font-weight: 600;
      letter-spacing: .1em;
      text-transform: uppercase;
      padding: 4px 10px;
      border-radius: 999px;
      background: rgba(232,255,71,.12);
      color: var(--accent);
      border: 1px solid rgba(232,255,71,.3);
      flex-shrink: 0;
    }
    .kurs-badge.none {
      background: rgba(107,107,138,.1);
      color: var(--muted);
      border-color: var(--border);
    }

    /* ‚îÄ‚îÄ MANUAL SELECTOR ‚îÄ‚îÄ */
    details {
      margin-top: 14px;
    }
    summary {
      cursor: pointer;
      font-size: .8rem;
      color: var(--accent2);
      font-weight: 500;
      list-style: none;
      display: flex;
      align-items: center;
      gap: 6px;
      user-select: none;
    }
    summary::-webkit-details-marker { display: none; }
    summary .chevron { transition: transform .2s; font-size: .7rem; }
    details[open] summary .chevron { transform: rotate(90deg); }

    .kurs-grid {
      margin-top: 14px;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
    }

    .kurs-btn {
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 12px 14px;
      cursor: pointer;
      text-align: left;
      transition: border-color .15s, background .15s, transform .1s;
      color: var(--text);
      font-family: var(--font-body);
    }
    .kurs-btn:hover {
      border-color: rgba(232,255,71,.4);
      background: rgba(232,255,71,.04);
    }
    .kurs-btn.selected {
      border-color: var(--accent);
      background: rgba(232,255,71,.08);
    }
    .kurs-btn:active { transform: scale(.97); }
    .kurs-btn .kbday {
      font-size: .65rem;
      font-weight: 600;
      letter-spacing: .1em;
      text-transform: uppercase;
      color: var(--muted);
      margin-bottom: 4px;
    }
    .kurs-btn .kbname {
      font-size: .9rem;
      font-weight: 500;
    }
    .kurs-btn .kbtime {
      font-size: .75rem;
      color: var(--muted);
    }

    /* ‚îÄ‚îÄ ATHLETE SEARCH ‚îÄ‚îÄ */
    .search-wrap {
      position: relative;
    }
    .search-wrap svg {
      position: absolute;
      left: 14px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--muted);
      pointer-events: none;
    }
    input[type="text"] {
      width: 100%;
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 14px 14px 14px 42px;
      font-family: var(--font-body);
      font-size: .95rem;
      color: var(--text);
      outline: none;
      transition: border-color .15s;
    }
    input[type="text"]::placeholder { color: var(--muted); }
    input[type="text"]:focus { border-color: var(--accent2); }

    .athlete-list {
      margin-top: 10px;
      display: flex;
      flex-direction: column;
      gap: 6px;
      max-height: 260px;
      overflow-y: auto;
      padding-right: 4px;
    }
    .athlete-list::-webkit-scrollbar { width: 4px; }
    .athlete-list::-webkit-scrollbar-track { background: transparent; }
    .athlete-list::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

    .athlete-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 16px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: var(--surface2);
      cursor: pointer;
      transition: border-color .15s, background .15s, transform .1s;
    }
    .athlete-item:hover {
      border-color: rgba(71,212,255,.4);
      background: rgba(71,212,255,.04);
    }
    .athlete-item.selected {
      border-color: var(--accent2);
      background: rgba(71,212,255,.08);
    }
    .athlete-item:active { transform: scale(.98); }
    .athlete-avatar {
      width: 34px;
      height: 34px;
      border-radius: 50%;
      background: var(--border);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: .85rem;
      flex-shrink: 0;
      color: var(--accent2);
      border: 1px solid rgba(71,212,255,.2);
    }
    .athlete-name { font-size: .9rem; font-weight: 500; }
    .athlete-check { margin-left: auto; color: var(--accent2); opacity: 0; transition: opacity .15s; }
    .athlete-item.selected .athlete-check { opacity: 1; }

    .empty-state {
      text-align: center;
      padding: 24px 0;
      color: var(--muted);
      font-size: .85rem;
    }

    /* ‚îÄ‚îÄ SUBMIT BUTTON ‚îÄ‚îÄ */
    .btn-submit {
      width: 100%;
      max-width: 480px;
      padding: 18px;
      background: var(--accent);
      color: #0a0a0f;
      border: none;
      border-radius: 16px;
      font-family: var(--font-head);
      font-size: 1.3rem;
      letter-spacing: .12em;
      cursor: pointer;
      transition: transform .15s, box-shadow .15s, filter .15s;
      animation: fadeUp .45s .12s ease both;
      box-shadow: 0 4px 32px rgba(232,255,71,.25);
    }
    .btn-submit:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 40px rgba(232,255,71,.4);
    }
    .btn-submit:active { transform: scale(.98); }
    .btn-submit:disabled {
      filter: saturate(0);
      opacity: .4;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    /* ‚îÄ‚îÄ SUCCESS / ERROR OVERLAYS ‚îÄ‚îÄ */
    .overlay {
      position: fixed;
      inset: 0;
      background: rgba(10,10,15,.92);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 100;
      opacity: 0;
      pointer-events: none;
      transition: opacity .3s;
      backdrop-filter: blur(8px);
      padding: 32px;
      text-align: center;
    }
    .overlay.show {
      opacity: 1;
      pointer-events: all;
    }
    .overlay-icon {
      font-size: 4rem;
      margin-bottom: 20px;
      animation: bounceIn .4s ease both;
    }
    .overlay-title {
      font-family: var(--font-head);
      font-size: 2.4rem;
      letter-spacing: .06em;
      margin-bottom: 10px;
    }
    .overlay-sub {
      color: var(--muted);
      font-size: .9rem;
      max-width: 300px;
      line-height: 1.6;
    }
    .overlay-btn {
      margin-top: 28px;
      padding: 14px 32px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: var(--surface);
      color: var(--text);
      font-family: var(--font-body);
      font-size: .9rem;
      font-weight: 500;
      cursor: pointer;
      transition: border-color .15s, background .15s;
    }
    .overlay-btn:hover { border-color: var(--accent); }

    /* ‚îÄ‚îÄ LOADING ‚îÄ‚îÄ */
    .spinner {
      width: 40px;
      height: 40px;
      border: 3px solid var(--border);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin .8s linear infinite;
      margin: 24px auto;
    }

    /* ‚îÄ‚îÄ CLOCK ‚îÄ‚îÄ */
    .clock-bar {
      width: 100%;
      max-width: 480px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0 4px;
      margin-bottom: 20px;
      font-size: .75rem;
      color: var(--muted);
      animation: fadeDown .5s .05s ease both;
    }
    .clock-time { font-variant-numeric: tabular-nums; font-weight: 500; color: var(--text); }

    /* ‚îÄ‚îÄ ANIMATIONS ‚îÄ‚îÄ */
    @keyframes fadeDown { from { opacity:0; transform:translateY(-16px); } to { opacity:1; transform:none; } }
    @keyframes fadeUp   { from { opacity:0; transform:translateY(16px);  } to { opacity:1; transform:none; } }
    @keyframes pulse    { 0%,100%{box-shadow:0 0 8px var(--accent);} 50%{box-shadow:0 0 20px var(--accent);} }
    @keyframes spin     { to { transform: rotate(360deg); } }
    @keyframes bounceIn { 0%{transform:scale(.3);opacity:0;} 70%{transform:scale(1.1);} 100%{transform:scale(1);opacity:1;} }
  </style>
</head>
<body>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     SUCCESS OVERLAY
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="overlay" id="overlaySuccess">
  <div class="overlay-icon">ü•ã</div>
  <div class="overlay-title" id="successTitle">Danke, du bist EINGECHECKT!</div>
  <div class="overlay-sub" id="successSub"></div>
  <button class="overlay-btn" onclick="resetForm()">Weiter ‚Üí</button>
</div>

<!-- ERROR OVERLAY -->
<div class="overlay" id="overlayError">
  <div class="overlay-icon">‚ö†Ô∏è</div>
  <div class="overlay-title">FEHLER</div>
  <div class="overlay-sub" id="errorMsg"></div>
  <button class="overlay-btn" onclick="hideOverlays()">Zur√ºck</button>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     MAIN UI
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<header>
  <div class="logo-icon">
    <svg viewBox="0 0 24 24" fill="none" stroke="#0a0a0f" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
      <path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/>
    </svg>
  </div>
  <h1>ATHLETEN <span>CHECK-IN</span></h1>
  <p class="header-sub"> Logo dich ein</p>
</header>

<div class="clock-bar">
  <span id="dateDisplay">‚Äî</span>
  <span class="clock-time" id="clockDisplay">‚Äî</span>
</div>

<!-- KURS CARD -->
<div class="card">
  <div class="card-label">Aktueller Kurs</div>

  <div class="kurs-display">
    <span class="kurs-dot" id="kursDot"></span>
    <div>
      <div class="kurs-name" id="kursName">Kein aktiver Kurs</div>
      <div class="kurs-time" id="kursTime">N√§chster Kurs wird angezeigt</div>
    </div>
    <span class="kurs-badge none" id="kursBadge">INAKTIV</span>
  </div>

  <details id="manualDetails">
    <summary>
      <span>‚ñ∂</span><span class="chevron">‚Ä∫</span>
      Kurs manuell ausw√§hlen
    </summary>
    <div class="kurs-grid" id="kursGrid">
      <!-- filled by JS -->
    </div>
  </details>
</div>

<!-- ATHLETE CARD -->
<div class="card">
  <div class="card-label">Athlet w√§hlen</div>

  <div class="search-wrap">
    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/>
    </svg>
    <input type="text" id="searchInput" placeholder="Name suchen‚Ä¶" autocomplete="off" spellcheck="false" />
  </div>

  <div class="athlete-list" id="athleteList">
    <div class="spinner"></div>
  </div>
</div>

<!-- SUBMIT -->
<button class="btn-submit" id="btnSubmit" disabled onclick="submitCheckin()">
  CHECK-IN BEST√ÑTIGEN
</button>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     SCRIPT
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<script>
// ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
// ‚ïë           ‚öô  KONFIGURATION  ‚öô               ‚ïë
// ‚ïë  Hier deine Baserow-Werte eintragen:         ‚ïë
// ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
const CONFIG = {
  BASEROW_URL:    'https://api.baserow.io',           // Nicht √§ndern
  API_TOKEN:      'dLCtLqRkMjgTy3sPp7XOp31OUfozt1PK',             
  TABLE_ATHLETES: '846366',       
  TABLE_CHECKINS: '846386',    
};

// ‚îÄ‚îÄ Kursdefinitionen ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// day: 1=Mo, 2=Di, 3=Mi, 4=Do, 5=Fr (getDay() liefert 0=So..6=Sa)
const KURSE = [
  { id: 'mo-17', tag: 'Montag',     day: 1, start: '17:00', end: '19:00', label: 'Mo 17‚Äì19 Uhr' },
  { id: 'mo-19', tag: 'Montag',     day: 1, start: '19:00', end: '21:00', label: 'Mo 19‚Äì21 Uhr' },
  { id: 'mi-17', tag: 'Mittwoch',   day: 3, start: '17:00', end: '19:00', label: 'Mi 17‚Äì19 Uhr' },
  { id: 'mi-19', tag: 'Mittwoch',   day: 3, start: '19:00', end: '21:00', label: 'Mi 19‚Äì21 Uhr' },
  { id: 'fr-16', tag: 'Freitag',    day: 5, start: '16:30', end: '18:30', label: 'Fr 16:30‚Äì18:30 Uhr' },
];

// How many minutes BEFORE start is the check-in window open?
const CHECKIN_OPEN_BEFORE_MIN = 20;

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let allAthletes    = [];
let selectedAthlete = null;
let selectedKurs    = null;

// ‚îÄ‚îÄ Clock ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function updateClock() {
  const now = new Date();
  const days = ['Sonntag','Montag','Dienstag','Mittwoch','Donnerstag','Freitag','Samstag'];
  document.getElementById('dateDisplay').textContent =
    days[now.getDay()] + ', ' +
    now.toLocaleDateString('de-DE', { day:'2-digit', month:'long', year:'numeric' });
  document.getElementById('clockDisplay').textContent =
    now.toLocaleTimeString('de-DE', { hour:'2-digit', minute:'2-digit', second:'2-digit' });
}
setInterval(updateClock, 1000);
updateClock();

// ‚îÄ‚îÄ Kurs-Logik ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function parseTime(str) {
  const [h, m] = str.split(':').map(Number);
  return h * 60 + m;
}

function getCurrentKurs() {
  const now = new Date();
  const dayOfWeek = now.getDay();
  const nowMin = now.getHours() * 60 + now.getMinutes();

  return KURSE.find(k => {
    if (k.day !== dayOfWeek) return false;
    const start = parseTime(k.start) - CHECKIN_OPEN_BEFORE_MIN;
    const end   = parseTime(k.end);
    return nowMin >= start && nowMin < end;
  }) || null;
}

function getNextKurs() {
  const now = new Date();
  const dayOfWeek = now.getDay();
  const nowMin = now.getHours() * 60 + now.getMinutes();

  // same day, future
  const sameDay = KURSE.filter(k => k.day === dayOfWeek && parseTime(k.start) > nowMin);
  if (sameDay.length) return sameDay[0];

  // next days (cycle through week)
  for (let offset = 1; offset <= 7; offset++) {
    const d = (dayOfWeek + offset) % 7;
    const found = KURSE.find(k => k.day === d);
    if (found) return found;
  }
  return null;
}

function setActiveKurs(kurs) {
  selectedKurs = kurs;
  const dot   = document.getElementById('kursDot');
  const name  = document.getElementById('kursName');
  const time  = document.getElementById('kursTime');
  const badge = document.getElementById('kursBadge');

  if (kurs) {
    dot.classList.remove('inactive');
    name.textContent = kurs.tag;
    time.textContent = kurs.start + ' ‚Äì ' + kurs.end + ' Uhr';
    badge.textContent = 'AKTIV';
    badge.classList.remove('none');
  } else {
    dot.classList.add('inactive');
    const next = getNextKurs();
    name.textContent = 'Kein aktiver Kurs';
    time.textContent = next ? 'N√§chster: ' + next.label : '‚Äî';
    badge.textContent = 'INAKTIV';
    badge.classList.add('none');
  }

  // highlight correct button in grid
  document.querySelectorAll('.kurs-btn').forEach(btn => {
    btn.classList.toggle('selected', btn.dataset.id === (kurs?.id ?? ''));
  });

  updateSubmitBtn();
}

// ‚îÄ‚îÄ Build Kurs Grid ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function buildKursGrid() {
  const grid = document.getElementById('kursGrid');
  grid.innerHTML = KURSE.map(k => `
    <button class="kurs-btn" data-id="${k.id}" onclick="manualSelectKurs('${k.id}')">
      <div class="kbday">${k.tag}</div>
      <div class="kbname">${k.id.includes('fr') ? 'Kurs' : 'Kurs'}</div>
      <div class="kbtime">${k.start} ‚Äì ${k.end}</div>
    </button>
  `).join('');
}

function manualSelectKurs(id) {
  const kurs = KURSE.find(k => k.id === id);
  setActiveKurs(kurs);
  // update dot to show it's manually overridden
  document.getElementById('kursBadge').textContent = 'MANUELL';
  document.getElementById('kursBadge').classList.remove('none');
  // close details
  document.getElementById('manualDetails').removeAttribute('open');
}

// ‚îÄ‚îÄ Baserow API ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function fetchAthletes() {
  try {
    let url = `${CONFIG.BASEROW_URL}/api/database/rows/table/${CONFIG.TABLE_ATHLETES}/?user_field_names=true&size=200`;
    const res = await fetch(url, {
      headers: { Authorization: `Token ${CONFIG.API_TOKEN}` }
    });
    if (!res.ok) throw new Error(`HTTP ${res.status}: ${await res.text()}`);
    const data = await res.json();
    return data.results;
  } catch (e) {
    console.error(e);
    document.getElementById('athleteList').innerHTML =
      `<div class="empty-state">‚ö†Ô∏è Athleten konnten nicht geladen werden.<br><small>${e.message}</small></div>`;
    return [];
  }
}

async function postCheckin(athleteName, kursLabel) {
  const now = new Date();
  const body = {
    Athlet:   athleteName,
    Kurs:     kursLabel,
    Datum:    now.toISOString().split('T')[0],
    Uhrzeit:  now.toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' }),
    Timestamp: now.toISOString(),
  };
  const res = await fetch(
    `${CONFIG.BASEROW_URL}/api/database/rows/table/${CONFIG.TABLE_CHECKINS}/?user_field_names=true`,
    {
      method:  'POST',
      headers: {
        Authorization:  `Token ${CONFIG.API_TOKEN}`,
        'Content-Type': 'application/json',
      },
      body: JSON.stringify(body),
    }
  );
  if (!res.ok) throw new Error(`HTTP ${res.status}: ${await res.text()}`);
  return res.json();
}

// ‚îÄ‚îÄ Athlete List UI ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderAthletes(list) {
  const container = document.getElementById('athleteList');
  if (!list.length) {
    container.innerHTML = '<div class="empty-state">Keine Athleten gefunden</div>';
    return;
  }
  container.innerHTML = list.map(a => {
    const name = a.Name || a.name || Object.values(a).find(v => typeof v === 'string' && v.trim()) || '?';
    const initials = name.split(' ').map(w => w[0]).join('').toUpperCase().slice(0,2);
    return `
      <div class="athlete-item" data-name="${name}" onclick="selectAthlete('${name.replace(/'/g,"\\'")}', this)">
        <div class="athlete-avatar">${initials}</div>
        <span class="athlete-name">${name}</span>
        <svg class="athlete-check" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>
      </div>`;
  }).join('');
}

function selectAthlete(name, el) {
  selectedAthlete = name;
  document.querySelectorAll('.athlete-item').forEach(i => i.classList.remove('selected'));
  el.classList.add('selected');
  updateSubmitBtn();
  // scroll to keep visible
  el.scrollIntoView({ block: 'nearest', behavior: 'smooth' });
}

function updateSubmitBtn() {
  const btn = document.getElementById('btnSubmit');
  btn.disabled = !(selectedAthlete && selectedKurs);
}

// ‚îÄ‚îÄ Search ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
document.getElementById('searchInput').addEventListener('input', function() {
  const q = this.value.toLowerCase();
  const filtered = allAthletes.filter(a => {
    const name = a.Name || a.name || '';
    return name.toLowerCase().includes(q);
  });
  renderAthletes(filtered);
});

// ‚îÄ‚îÄ Submit ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function submitCheckin() {
  if (!selectedAthlete || !selectedKurs) return;
  const btn = document.getElementById('btnSubmit');
  btn.disabled = true;
  btn.textContent = 'WIRD GESPEICHERT‚Ä¶';

  try {
    await postCheckin(selectedAthlete, selectedKurs.label);
    document.getElementById('successTitle').textContent = 'EINGECHECKT!';
    document.getElementById('successSub').textContent =
      `${selectedAthlete} wurde erfolgreich f√ºr den Kurs\n"${selectedKurs.label}" eingetragen.`;
    document.getElementById('overlaySuccess').classList.add('show');
  } catch (e) {
    document.getElementById('errorMsg').textContent = e.message;
    document.getElementById('overlayError').classList.add('show');
    btn.disabled = false;
    btn.textContent = 'CHECK-IN BEST√ÑTIGEN';
  }
}

function hideOverlays() {
  document.querySelectorAll('.overlay').forEach(o => o.classList.remove('show'));
}

function resetForm() {
  hideOverlays();
  selectedAthlete = null;
  document.querySelectorAll('.athlete-item').forEach(i => i.classList.remove('selected'));
  document.getElementById('searchInput').value = '';
  renderAthletes(allAthletes);
  document.getElementById('btnSubmit').textContent = 'CHECK-IN BEST√ÑTIGEN';
  updateSubmitBtn();
  // re-detect kurs
  setActiveKurs(getCurrentKurs());
}

// ‚îÄ‚îÄ INIT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function init() {
  buildKursGrid();
  setActiveKurs(getCurrentKurs());

  allAthletes = await fetchAthletes();
  renderAthletes(allAthletes);
}

init();
</script>
</body>
</html>
